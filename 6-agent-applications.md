# HotSchedules®
___

# Overview
This document serves as a step by step guide to writing and deploying a simple agent app. It assumes only one thing, that you have an agent up and running. It assumes absolutely no knowledge of any programming language, database technology or API experience.

# Goals
Provide the reader with the knowledge required to write a “Hello World” style agent app.
Teach the reader the process of deploying the agent app, and how to see output in the log file which will be generated by the agent.

# What is an agent app?
An agent app is an event driven application. Unlike other applications which are often more center stage for users, agent apps can be seen as more of a backend utility. For example, an agent app can be written to listen for events, such as monitoring a directory, waiting on data to arrive over an API, and then firing off tasks based on the event and the data within.

## What will the agent app in this document do?
The agent app in this document will contain only two main objectives : 

* ###A basic event handler
An event handler is essentially a piece of code that gets executed when a given event takes place.

* ###A way to fire off the event handler
This will be done by writing a line of code which will be the “event” we are looking for.

# Preparation 
This section will discuss the early stages of getting an agent app up and running. 
##Agent health check
Assuming you have an agent set-up and running already, and have checked the health of it by running : 

```agent-cli status```

The output you are expecting to see here is a line that says _“agent available”_.

##Clone the agent app template
This section will discuss the steps needed to actually get a copy of the basic agent app template. The basic template app is hosted as a public repository for all developers to get a copy of, and begin altering to see results with very little prior coding knowledge.

###Install SourceTree
SourceTree is a source control client which is compatible with git and mercurial type repositories. You can download it at the link below : 

```https://www.sourcetreeapp.com/```

Setup is fairly straightforward, and works on both windows and mac computers.

###Getting the HelloWorld project
Now that you have a copy of SourceTree installed, it is time to actually go ahead and clone the repository. Don’t worry too much about the nuances of source control yet if you haven’t seen it before, this isn’t overly complicated.
The HelloWorld agent app template is actually hosted on bitbucket, which integrates very well with SourceTree. Open up your browser and head on over to : 

```https://bitbucket.org/LeamD/helloworld```

If you look at the top of the page, there will be a button with a downward facing arrow on it.
 
Click on it - it means “Clone in SourceTree”.
You will see a dialog. Keep a note of the destination path, then click “Clone.”

>NOTE : From here on out - we will refer to the destination path in the above dialog as “agent-app-directory” - Wherever it is mentioned in this document, you must substitute it with the directory you chose as your own destination path.

# Editing the project
Use your preferred method to look at the contents of the agent-app-directory. It should contain the following files : 

* app.js
* Gruntfile.js
* LICENCSE.md
* package.json
* README.md

These files are the basis for our agent app. Each of the files is important.

app.js - This is going to be the entry point of our application, where we will write code.

package.json - This file holds the dependencies, so that node can be used to get everything required in order to run the agent app.

Gruntfile.js - This is where grunt will look when kicking off the build tasks, prior to publishing.

The README and LICENSE files are required in order for deployment to take place. They basically take care of usage details, and various legal details.

## Writing a handler

Open up the app.js file in your favorite editor. Don’t be alarmed, the file is meant to be empty. We are going to write some simple code to get it doing something, feel free to either sit and type the code below manually, or copy and paste it. The real important part here is that you take the time to read the comments, and understand what is happening.

```
// Writing a nodejs module - so start off with module.exports
module.exports = 
{
    // Handlers are stored here in the handlers array.
    handlers: [        
    {
        // Name denotes the identifier of the handler.
        name: 'my simple handler',
        // Subscription is the topic we “listen” on in this handler.
        subscriptions: 'MyAwesomeTopic',
        // When the handler is triggered via the subscription, run this function
        // Which basically takes one variable as an argument, called “message”. 
        fn: function (message) 
        {
            // Creating a logger so that we can output to the logs.
            var logger = this.logger;
            // Using the logger to output the value of “message”.
            logger.verbose('GOT MESSAGE >>', message);
        }
    }], // End of handlers array.
    // On initialization of the app, run this function.
    init: function (done) {
        // Publishing the message “Hello, World!” via the topic “listenToMe”
        this.publish('MyAwesomeTopic', "Hello, World!");
        done();
    }
}

```

## Setting up package.json

Open the package.json file. It has quite a few things going on, a lot of which we aren’t really concerned with for this particular exercise. 

Just know that the package.json defines many things, from dependencies, deployment, licensing, versioning and even the name of your agent app.

### Naming the app
At the top of the file - you will see the following values : 

```"name": "",```

```"title": "",```


These need to be changed to have a name - Let’s go with “HelloWorld”, change them to : 

```"name": "HelloWorld",```

```"title": "HelloWorld",```

Next - You will see an empty tag beside the 
"author" tag. Update it with your email address, according to the following template:

```"author": "YourEmailAddressHere",```

Similarly, the will also be a "name" section inside the section that starts with "profile", make sure to also populate the adjacent empty string ("") with the name "HelloWorld".

Remember that repository you created on bitbucket earlier in this document? At this stage we need to go back to it and get the URL for the repo.
Visit bitbucket, and login. Click “Repositories”, and select your repository from the list.
At the top of the page you are taken to, you will see a control which looks like the one on the right.

Copy all of the text from that textbox. You are going to need it in a second.
Next, scroll down to the "repository" section. You will see that the values for "type" and "url" are left blank. Change them to look like this :

```"type": "git",```
```"url" : "Paste the URL here!"```

Excellent. You have now successfully configured your project to be linked to a bitbucket repository.

# Publish to artifactory
This is the final step of the process before you can install your agent app on your agent installation.

## preparing your artifactory credentials

The first thing you need is your artifactory credentials.

npmrc takes a base64 encoded version of your username and password. We need to encode it for use with npmrc so that it may be published.

First, go to any base64 encoding site. The one below is fine :

https://www.base64encode.org

You will see two text areas, the one at the top says "Type (or paste) here...". In this box, you need to enter in your username and password for artifactory, separated by a colon. For example, if your username were _"JohnSmith"_, and your password were "Password123!" - then you would type the following :

```JohnSmith:Password123!```

Now press the > ENCODE < button, and you will see a weird looking set of values appear in the bottom box. 

If you typed :

```JohnSmith:Password123!```... 

then you would see the following : 

```Sm9oblNtaXRoOlBhc3N3b3JkMTIzIQ==```

That is your base 64 encoded username and password, keep a note of it.

## Installing npmrc and setting up the .npmrc file

To install npmrc - simply open up a terminal and type the following npm install command : 

```npm install -g npmrc```

Now you need to edit the npmrc file. It is a hidden file in your home directory, edit it as follows.

```vim ~/.npmrc```

It should be blank, if it isn't, delete the content of the file (except the first line if it begins with "//").

We need three values in here, the first one is your auth details.

The first is the __registry__, which is the location of your artifactory store. which looks like this : 

```registry=<artifactory url>/location/to/archive```

Next, lets add the __ _auth __ tag, as follows :
```_auth=<your base64 encoded string>```

and lastly - email:

```email=<Your email address>```

### Publish

browse to your project directory :

```cd /path/to/project/```

and issue the following npm command to publish to artifactory:

```npm publish```

# Installing your app
Installing has a few small steps involved in order to get up and running.

## Downloading the app
Open up a terminal window and issue the following command to bring the app into your agent's environment.

```agent-cli download <agent app name>```

## Installing required node modules

You need to now install any required node modules that are needed to get the app up and running :

```cd <BodhiAgentDirectory>/node_modules/<AppName>```

```npm install```

## Edit the agent.json file
In the main directory of the agent, you will see a file named _agent.json_ - This is basically what need to be edited in order o make the agent aware of the app.

In this file, there will be an array of json items which is named "apps" - Make it look like this :

```
  "apps": {
    "AppName": {
      "module": "AppName",
      "enabled": true,
      "logger": {
        "level": "debug",
        "filename": "AppName.log"
      },
      "settings": [
        
      ]
    }
  }
 ```
 _Where "AppName" is the name of your application._
 
 ## Restart the agent
 
 Now restart the agent with the following command.
 
 ```agent-cli restart```
 
 After a few seconds, you should see the log file get created and begin to be populated.

